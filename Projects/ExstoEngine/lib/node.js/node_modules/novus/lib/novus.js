(function (exports) {
    var io = require('socket.io'),
    	config = require('./config'),
    	fs = require('fs'),
    	path = require('path'),
        nv = exports;
    
	nv.version = '0.0.1';
    
    nv.app = {};

    nv.listen = function(app) {
        nv.app = app;
        
        app.on('request', function (req, res) {
          var parts = require('url').parse(req.url);
          if(parts.pathname == '/novus') {
            var fileName = path.join(__dirname, '/../app/index.html');
            console.log(fileName);
            fs.readFile(fileName,
                function (err, data) {
                  if (err) {
                    res.writeHead(500);
                    return res.end('Error loading index.html');
                  }
    
                  res.writeHead(200);
                  res.end(data);
                });
          }
        });
        
        var server = io.listen(app);
        
        server.sockets.on('connection', function(socket) {
            nv.UserManager.bind(socket);
            nv.RoomManager.bind(socket);
            
            socket.on('disconnect', function (data) {
        		socket.get('user', function (err, user) {
        			nv.UserManager.disconnect(user);
            		nv.RoomManager.disconnect(user);
        		});
            });
        });
    };
    
    nv.configure = config.configure,
    
    nv.UserManager = require('./usermanager');
    
    nv.RoomManager = require('./roommanager');
})(exports);