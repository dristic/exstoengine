var io = require('socket.io'),
	Room = require('./room'),
	um = require('./usermanager'),
	rm = exports;

rm.bind = function(socket) {
	socket.on('roomList', function(data) {
		socket.emit('roomList', { list: rm.rooms });
	});
	
	// Create room
	socket.on('createRoom', function(data) {
		var user = um.getUser(socket);
		if(user != null) {
			var room = rm.findRoom(data.name);
			if(room == null) {
				room = rm.createRoom(data.name, user);
				socket.broadcast.emit('createRoom', { room: room });
			}
		}
	});
	
	// Join room
	socket.on('joinRoom', function(data) {
		var room = rm.findRoom(data.name);
		var user = um.getUser(socket);
		rm.joinRoom(user, room);
		socket.emit('joinRoom', { success: true });
	});
	
	// Leave room
	socket.on('leaveRoom', function(data) {
		var user = um.getUser(socket);
		if(user != null) {
			rm.leaveRoom(user);
		};
	});
	
	socket.on('roomMessage', function(data) {
		var user = um.getUser(socket),
			room = rm.getRoom(user.currentRoom);
		
		socket.broadcast.to(room.name).emit('roomMessage', data);
	});
	
	socket.on('roomMessageTo', function(data) {
		var otherUser = um.findUser(data.name);
		
		if(otherUser != null) {
			otherUser.conn.emit('roomMessage', data);
		}
	});
};

rm.rooms = [];

rm.createRoom = function(name, creator) {
	var room = new Room(name, creator);
	rm.rooms.push(room);
	return room;
};

rm.joinRoom = function(user, room) {
	if(user.currentRoom != -1) {
		rm.leaveRoom(user);
	}
	user.currentRoom = room.id;
	room.users.push(user.id);
	user.conn.join(room.name);
};

rm.leaveRoom = function(user) {
	rm.getRoom(user.currentRoom).removeUser(user);
	user.currentRoom = -1;
};

rm.getRoom = function(roomId) {
	var ret = null;
	
	rm.rooms.forEach(function (item, index, array) {
		if(item.id == roomId) {
			ret = item;
			return false;
		}
	});
	
	return ret;
};

rm.findRoom = function(name) {
	var ret = null;
	
	rm.rooms.forEach(function (room, index, array) {
		if(room.name == name) {
			ret = room;
			return false;
		}
	});
	
	return ret;
};